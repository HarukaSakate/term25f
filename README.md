# term25f
VM間でOBSを用いた動画配信を成功させるための手順の全体像を、設定した内容に基づいてまとめて解説します。

## 1\. ネットワーク環境の構築とIPアドレスの設定

VM間で相互に通信できるようにするため、VirtualBoxの「内部ネットワーク」機能を使用し、両方のVMに**静的IPv4アドレス**を設定します。

| 設定項目 | 配信VM（OBS側） | 受信VM（RTMPサーバー側） |
| :--- | :--- | :--- |
| **VirtualBox設定** | ネットワークアダプターを**内部ネットワーク**に設定し、**名前を一致**させる | ネットワークアダプターを**内部ネットワーク**に設定し、**名前を一致**させる |
| **IPアドレス** | **`10.0.0.20/24`** | **`10.0.0.10/24`** |
| **コマンド例** | `sudo ip addr add 10.0.0.20/24 dev enp0s3` | `sudo ip addr add 10.0.0.10/24 dev enp0s3` |

### 💡 補足

  * `10.0.0.x`のアドレスは、VMの再起動で消えることがあるため、再起動後は`ip a`で確認し、必要に応じて上記コマンドを再実行してください。
  * この設定により、配信VMから受信VMへ **`ping 10.0.0.10`** が通るようになります。

## 2\. RTMPサーバー（Nginx）の設定

配信データを受け付け、視聴者に中継するRTMPサーバーを\*\*受信VM（`10.0.0.10`）\*\*に構築します。

1.  **NginxとRTMPモジュールのインストール:**

    ```bash
    sudo apt update
    sudo apt install nginx libnginx-mod-rtmp -y
    ```

2.  **Nginx設定ファイル（`/etc/nginx/nginx.conf`）の編集:**
    ファイルの末尾に以下のRTMPブロックを追加します。

    ```nginx
    rtmp {
        server {
            listen 1935;             # RTMP標準ポート
            chunk_size 4096;
            application live {       # アプリケーション名（配信URLの一部）
                live on;
            }
        }
    }
    ```

3.  **Nginxの再起動:**
    設定を反映させ、サービスを起動します。

    ```bash
    sudo systemctl daemon-reload
    sudo systemctl restart nginx
    ```

4.  **動作確認:**
    ポート $1935$ が待ち受け状態になっていることを確認します。

    ```bash
    sudo ss -tulnp | grep 1935
    # 出力例: 0.0.0.0:1935 LISTEN
    ```

-----

## 3\. OBSからの配信設定と開始

\*\*配信VM（`10.0.0.20`）\*\*のOBSで、配信先をカスタムRTMPサーバーに設定します。

1.  **OBS「設定」→「配信」タブの設定:**

      * **サービス:** **カスタム...**
      * **サーバー (URL):** **`rtmp://10.0.0.10:1935/live`**
      * **ストリームキー:** **`myvideo`** （任意のキーを設定）

2.  **Luaスクリプトの設定:**
    動画の6回ループと自動停止を制御するLuaスクリプトを読み込み、\*\*「メディアソースを選択」\*\*のプロパティを正しく設定します。

3.  **配信開始:**
    OBSメイン画面の\*\*「配信開始」\*\*ボタンを押すと、RTMPサーバーへ動画ストリームが送信されます。

「サーバーへの接続に失敗しました」などと表示されるときはOSやOBSを再起動すると配信できるようになる。

-----

## 4\. 配信を視聴する方法（VLC）

RTMPサーバーと同じVM内で、ストリームを受信・再生します。

1.  **VLC Media Playerのインストール:**

    ```bash
    sudo apt install vlc -y
    ```

2.  **VLCでの視聴URL入力:**
    VLCを起動し、「メディア」→「ネットワークストリームを開く」を選択します。同じVM内のNginxにアクセスするため、**ローカルホストアドレス**を使用するのが最も確実です。

    **視聴URL:**
    $$\text{rtmp://127.0.0.1:1935/live/myvideo}$$

    （IPアドレスを `127.0.0.1` に、ポート、アプリケーション、ストリームキーはOBSの設定と一致させてください。）


## ipアドレスの設定
- [【Linux】IPアドレス固定＆アドレス変更方法](https://qiita.com/mtn_kt/items/633bd5e3e00732af564e) を参考に設定する。
 手動→IPアドレス
-  途切れる問題:  設定→ネットワーク→有線→Ipv4→手動　で適用

## TCコマンドの設定
    enp0s3の出力帯域を50Mbpsに制限、50msの遅延と10msのジッタを発生
    
     ```bash
     sudo tc qdisc add dev enp0s3 root handle 1:0 tbf rate 50mbit burst 25kb limit 250kb
     sudo tc qdisc add dev enp0s3 parent 1:1 handle 10:1 netem delay 50ms 10ms distribution normal
     sudo tc qdisc show dev enp0s3
     ```


 ### TC設定の削除
     
     sudo tc qdisc del dev enp0s3 root
     
## 📝 送信データ量（KiB）計測手順のまとめ
OBSの統計から見れる
### ステップ 1: パケットキャプチャの実行と取得

1.  [cite_start]**輻輳制御アルゴリズムの適用:** 実験で評価したい輻輳制御アルゴリズム（SACCまたはCubic）がRTMP通信のソケットに正しく適用されていることを確認します 。
2. **`tc`の設定:** 評価したいケースのネットワーク制限（帯域幅、遅延、ジッター）を配信側VMのネットワークインターフェースに`tc`コマンドで適用します。
3. **キャプチャの開始:** 配信側VMのRTMP通信を行うインターフェースで`tcpdump`を開始し、PCAPファイルとして保存します [cite: 71, 72]。
    ```bash
    sudo tcpdump -i <インターフェース名> tcp port 1935 -w rtmp_capture_X.pcap
    ```
4. **ライブストリーミング実行:** キャプチャ開始と同時にOBSで配信を開始し、60秒間（素材動画の再生時間）実行します。
5.  **キャプチャの停止:** 60秒経過後、配信と`tcpdump`を停止し、PCAPファイルを取得します。

### ステップ 2: Wiresharkによる分析とバイト数の特定

1.  **PCAPファイルを開く:** 取得したPCAPファイルをホストマシンなどでWiresharkで開きます。
2.  **RTMP通信の特定:** フィルタバーに `tcp.port == 1935` を入力し、RTMPパケットのみを表示します。
3.  **TCPストリームの追跡:** 表示されたRTMPパケットの一つを右クリックし、**「追跡 (Follow)」** → \*\*「TCPストリーム (TCP Stream)」\*\*を選択して、該当するセッションを分離します。
4.  **「会話」統計ウィンドウを開く:** メニューバーから **「統計 (Statistics)」** → **「会話 (Conversations)」を選択し、「TCP」タブ**に切り替えます。
5.  **送信バイト数の確認:** リストの中からポート1935を含む会話を探します。
      * 配信側VMのIPアドレス（Address A）から受信側VMのIPアドレス（Address B）へ流れたデータ量を示す、**「Bytes A $\to$ B」の値を記録します。この値はバイト（Bytes）単位の総データ量**です。

### ステップ 3: KiBへの単位換算

1. **換算式の適用:** ステップ2で確認した\*\*総バイト数（Bytes）**を、論文の単位である**KiB（キロバイト）\*\*に変換します。

$$\text{送信データ量 (KiB)} = \frac{\text{Bytes A} \to \text{B}}{1024}$$

